FROM node:{{node_version}}-alpine as base

RUN apk --no-cache --virtual build-dependencies add \
    bash \
    git \
    openssh \
    make \
    g++

WORKDIR /project

# Install deps in its own step, making rebuilds faster
# when just the Web3API schema & implementation files change
COPY package.json .
RUN yarn

# Copy all manifest files
{{#web3api_manifests}}
COPY {{.}} .
{{/web3api_manifests}}

# Copy all source files
{{#include}}
COPY {{.}} {{.}}
{{/include}}
{{#web3api_modules}}
COPY {{dir}} {{dir}}
{{/web3api_modules}}

{{#web3api_modules}}
# Build the module at {{dir}}
RUN ./node_modules/.bin/asc {{dir}}/w3/entry.ts \
    --path ./node_modules \
    --outFile ./build/pre-{{name}}.wasm \
    --use abort={{dir}}/w3/entry/w3Abort \
    --optimize --debug --importMemory \
    --runtime stub \
    --runPasses asyncify

RUN ./node_modules/binaryen/bin/wasm-opt ./build/pre-{{name}}.wasm \
    -O2 \
    -all \
    --pass-arg=asyncify-imports@w3.__w3_invoke_args,w3.__w3_invoke_result,w3.__w3_invoke_error,w3.__w3_abort,w3.__w3_log,w3.__w3_subinvoke_result_len,w3.__w3_subinvoke_error_len,w3.__w3_subinvoke_error,w3.__w3_subinvoke_result,w3.__w3_subinvoke \
    --output=./build/{{name}}.wasm

{{/web3api_modules}}
